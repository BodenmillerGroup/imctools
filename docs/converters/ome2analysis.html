<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.8.5" />
<title>imctools.converters.ome2analysis API documentation</title>
<meta name="description" content="" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js" integrity="sha256-eOgo0OtLL4cdq7RdwRUiGKLX9XsIJ7nGhWEKbohmVAQ=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>imctools.converters.ome2analysis</code></h1>
</header>
<section id="section-intro">
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">import logging
import os
from pathlib import Path
from typing import Optional, Sequence, Tuple, Type, Union

import numpy as np
import pandas as pd

from imctools.io.ometiff.ometiffparser import OmeTiffParser

logger = logging.getLogger(__name__)


def get_metals_from_panel(
    panel_csv_file: Optional[Union[str, Path]],
    usedcolumn: str = &#34;ilastik&#34;,
    metalcolumn: str = &#34;Metal Tag&#34;,
    sort_channels=True,
):
    &#34;&#34;&#34;Get list of metals from a panel and a boolean column.

    Parameters
    ----------
    panel_csv_file
        Name of the CSV file that contains the channels to be written out.
    metalcolumn
        Column name of the metal names.
    usedcolumn
        Column that should contain booleans (0, 1) if the channel should be used, i.e. &#34;ilastik&#34;.
    sort_channels
        Whether to sort channels by mass.
    &#34;&#34;&#34;
    metals = None

    if panel_csv_file is not None:

        pannel = pd.read_csv(panel_csv_file)
        if pannel.shape[1] &gt; 1:
            selected = pannel[usedcolumn]
            assert selected.any() == 0 or selected.any() == 1, f&#34;Values in &#39;usedcolumn&#39; column should contain only 0/1&#34;
            metals = [str(n) for s, n in zip(selected, pannel[metalcolumn]) if s]
        else:
            metals = [pannel.columns[0]] + pannel.iloc[:, 0].tolist()

    if sort_channels:
        if metals is not None:

            def mass_from_met(x):
                return int(&#34;&#34;.join([m for m in x if m.isdigit()])), x

            metals = sorted(metals, key=mass_from_met)

    return metals


def omefile_2_analysisfolder(
    filename: Union[str, Path],
    output_folder: Union[str, Path],
    basename: str,
    panel_csv_file: Optional[Union[str, Path]] = None,
    metalcolumn: str = &#34;Metal Tag&#34;,
    usedcolumn: str = &#34;ilastik&#34;,
    bigtiff=False,
    sort_channels=True,
    dtype: Optional[Type] = None,
):
    &#34;&#34;&#34;Converts single OME-TIFF file to folder compatible with IMC segmentation pipeline.

    Parameters
    ----------
    filename
        Path to input OME-TIFF file.
    output_folder
        Output folder.
    basename
        Basename of the acquisition.
    panel_csv_file
        Name of the CSV file that contains the channels to be written out.
    metalcolumn
        Column name of the metal names.
    usedcolumn
        Column that should contain booleans (0, 1) if the channel should be used, i.e. &#34;ilastik&#34;.
    bigtiff
        Whether to save TIFF files in BigTIFF format.
    sort_channels
        Whether to sort channels by mass.
    dtype
        Output Numpy data type.
    &#34;&#34;&#34;
    if isinstance(filename, str):
        filename = Path(filename)

    if isinstance(output_folder, str):
        output_folder = Path(output_folder)

    if not output_folder.exists():
        output_folder.mkdir(parents=True, exist_ok=True)

    metals = get_metals_from_panel(panel_csv_file, usedcolumn, metalcolumn, sort_channels)

    ome = OmeTiffParser(filename)
    acquisition_data = ome.get_acquisition_data()

    acquisition_data.save_tiff(
        output_folder / (basename + &#34;.tiff&#34;), names=metals, imagej=True, bigtiff=bigtiff, dtype=dtype
    )

    if metals is not None:
        savenames = metals
    else:
        savenames = [s for s in acquisition_data.channel_names]

    with open(output_folder / (basename + &#34;.csv&#34;), &#34;w&#34;) as f:
        for n in savenames:
            f.write(n + &#34;\n&#34;)


def omefolder_to_analysisfolder(
    input_folder: Union[str, Path],
    output_folder: Union[str, Path],
    panel_csv_file: Union[str, Path],
    analysis_stacks: Sequence[Tuple[str, str, bool]],
    metalcolumn: str = &#34;Metal Tag&#34;,
    dtype=np.uint16,
):
    &#34;&#34;&#34;Convert OME tiffs to analysis tiffs that are more compatible with tools. A CSV with a boolean column can be used to select subsets of channels or metals from the stack. The channels of the tiff will have the same order as in the csv.&#39;

    Parameters
    ----------
    input_folder
        Input folder
    output_folder
        Output folder
    panel_csv_file
        Name of the CSV file that contains the channels to be written out.
    analysis_stacks
        Array of analysis stack definitions in a tuple format (column, suffix, add_sum).
    metalcolumn
        Column name of the metal names.
    dtype
        Output numpy dtype
    &#34;&#34;&#34;
    if isinstance(input_folder, str):
        input_folder = Path(input_folder)
    if isinstance(output_folder, str):
        output_folder = Path(output_folder)

    if not output_folder.exists():
        output_folder.mkdir(parents=True, exist_ok=True)

    for fol in os.listdir(input_folder):
        sub_fol = input_folder / fol
        for img in os.listdir(sub_fol):
            if not img.endswith(&#34;.ome.tiff&#34;):
                continue
            basename = img.rstrip(&#34;.ome.tiff&#34;)
            for (col, suffix, add_sum) in analysis_stacks:
                try:
                    omefile_2_analysisfolder(
                        sub_fol / img,
                        output_folder,
                        basename + suffix,
                        panel_csv_file=panel_csv_file,
                        metalcolumn=metalcolumn,
                        usedcolumn=col,
                        bigtiff=False,
                        dtype=dtype,
                    )
                except:
                    logger.exception(&#34;Error in {}&#34;.format(img))


if __name__ == &#34;__main__&#34;:
    import timeit

    tic = timeit.default_timer()

    omefile_2_analysisfolder(
        Path(
            &#34;/home/anton/Downloads/imc_folder/20170905_Fluidigmworkshopfinal_SEAJa/20170905_Fluidigmworkshopfinal_SEAJa_s0_a0_ac.ome.tiff&#34;
        ),
        Path(&#34;/home/anton/Downloads/analysis_folder&#34;),
        &#34;test&#34;,
        panel_csv_file=Path(&#34;/home/anton/Downloads/example_panel.csv&#34;),
        metalcolumn=&#34;Metal Tag&#34;,
        usedcolumn=&#34;ilastik&#34;,
    )

    # omefolder_to_analysisfolder(
    #     &#34;/home/anton/Downloads/imc_folder&#34;,
    #     &#34;/home/anton/Downloads/analysis_folder&#34;,
    #     &#34;/home/anton/Downloads/example_panel.csv&#34;,
    #     [
    #         (&#34;ilastik&#34;, &#34;_ilastik&#34;, True),
    #         (&#34;full&#34;, &#34;_full&#34;, False)
    #     ],
    #     metalcolumn=&#34;Metal Tag&#34;,
    # )

    print(timeit.default_timer() - tic)</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="imctools.converters.ome2analysis.get_metals_from_panel"><code class="name flex">
<span>def <span class="ident">get_metals_from_panel</span></span>(<span>panel_csv_file: Union[str, pathlib.Path, NoneType], usedcolumn: str = 'ilastik', metalcolumn: str = 'Metal Tag', sort_channels=True)</span>
</code></dt>
<dd>
<div class="desc"><p>Get list of metals from a panel and a boolean column.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>panel_csv_file</code></strong></dt>
<dd>Name of the CSV file that contains the channels to be written out.</dd>
<dt><strong><code>metalcolumn</code></strong></dt>
<dd>Column name of the metal names.</dd>
<dt><strong><code>usedcolumn</code></strong></dt>
<dd>Column that should contain booleans (0, 1) if the channel should be used, i.e. "ilastik".</dd>
<dt><strong><code>sort_channels</code></strong></dt>
<dd>Whether to sort channels by mass.</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def get_metals_from_panel(
    panel_csv_file: Optional[Union[str, Path]],
    usedcolumn: str = &#34;ilastik&#34;,
    metalcolumn: str = &#34;Metal Tag&#34;,
    sort_channels=True,
):
    &#34;&#34;&#34;Get list of metals from a panel and a boolean column.

    Parameters
    ----------
    panel_csv_file
        Name of the CSV file that contains the channels to be written out.
    metalcolumn
        Column name of the metal names.
    usedcolumn
        Column that should contain booleans (0, 1) if the channel should be used, i.e. &#34;ilastik&#34;.
    sort_channels
        Whether to sort channels by mass.
    &#34;&#34;&#34;
    metals = None

    if panel_csv_file is not None:

        pannel = pd.read_csv(panel_csv_file)
        if pannel.shape[1] &gt; 1:
            selected = pannel[usedcolumn]
            assert selected.any() == 0 or selected.any() == 1, f&#34;Values in &#39;usedcolumn&#39; column should contain only 0/1&#34;
            metals = [str(n) for s, n in zip(selected, pannel[metalcolumn]) if s]
        else:
            metals = [pannel.columns[0]] + pannel.iloc[:, 0].tolist()

    if sort_channels:
        if metals is not None:

            def mass_from_met(x):
                return int(&#34;&#34;.join([m for m in x if m.isdigit()])), x

            metals = sorted(metals, key=mass_from_met)

    return metals</code></pre>
</details>
</dd>
<dt id="imctools.converters.ome2analysis.omefile_2_analysisfolder"><code class="name flex">
<span>def <span class="ident">omefile_2_analysisfolder</span></span>(<span>filename: Union[str, pathlib.Path], output_folder: Union[str, pathlib.Path], basename: str, panel_csv_file: Union[str, pathlib.Path, NoneType] = None, metalcolumn: str = 'Metal Tag', usedcolumn: str = 'ilastik', bigtiff=False, sort_channels=True, dtype: Union[Type, NoneType] = None)</span>
</code></dt>
<dd>
<div class="desc"><p>Converts single OME-TIFF file to folder compatible with IMC segmentation pipeline.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>filename</code></strong></dt>
<dd>Path to input OME-TIFF file.</dd>
<dt><strong><code>output_folder</code></strong></dt>
<dd>Output folder.</dd>
<dt><strong><code>basename</code></strong></dt>
<dd>Basename of the acquisition.</dd>
<dt><strong><code>panel_csv_file</code></strong></dt>
<dd>Name of the CSV file that contains the channels to be written out.</dd>
<dt><strong><code>metalcolumn</code></strong></dt>
<dd>Column name of the metal names.</dd>
<dt><strong><code>usedcolumn</code></strong></dt>
<dd>Column that should contain booleans (0, 1) if the channel should be used, i.e. "ilastik".</dd>
<dt><strong><code>bigtiff</code></strong></dt>
<dd>Whether to save TIFF files in BigTIFF format.</dd>
<dt><strong><code>sort_channels</code></strong></dt>
<dd>Whether to sort channels by mass.</dd>
<dt><strong><code>dtype</code></strong></dt>
<dd>Output Numpy data type.</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def omefile_2_analysisfolder(
    filename: Union[str, Path],
    output_folder: Union[str, Path],
    basename: str,
    panel_csv_file: Optional[Union[str, Path]] = None,
    metalcolumn: str = &#34;Metal Tag&#34;,
    usedcolumn: str = &#34;ilastik&#34;,
    bigtiff=False,
    sort_channels=True,
    dtype: Optional[Type] = None,
):
    &#34;&#34;&#34;Converts single OME-TIFF file to folder compatible with IMC segmentation pipeline.

    Parameters
    ----------
    filename
        Path to input OME-TIFF file.
    output_folder
        Output folder.
    basename
        Basename of the acquisition.
    panel_csv_file
        Name of the CSV file that contains the channels to be written out.
    metalcolumn
        Column name of the metal names.
    usedcolumn
        Column that should contain booleans (0, 1) if the channel should be used, i.e. &#34;ilastik&#34;.
    bigtiff
        Whether to save TIFF files in BigTIFF format.
    sort_channels
        Whether to sort channels by mass.
    dtype
        Output Numpy data type.
    &#34;&#34;&#34;
    if isinstance(filename, str):
        filename = Path(filename)

    if isinstance(output_folder, str):
        output_folder = Path(output_folder)

    if not output_folder.exists():
        output_folder.mkdir(parents=True, exist_ok=True)

    metals = get_metals_from_panel(panel_csv_file, usedcolumn, metalcolumn, sort_channels)

    ome = OmeTiffParser(filename)
    acquisition_data = ome.get_acquisition_data()

    acquisition_data.save_tiff(
        output_folder / (basename + &#34;.tiff&#34;), names=metals, imagej=True, bigtiff=bigtiff, dtype=dtype
    )

    if metals is not None:
        savenames = metals
    else:
        savenames = [s for s in acquisition_data.channel_names]

    with open(output_folder / (basename + &#34;.csv&#34;), &#34;w&#34;) as f:
        for n in savenames:
            f.write(n + &#34;\n&#34;)</code></pre>
</details>
</dd>
<dt id="imctools.converters.ome2analysis.omefolder_to_analysisfolder"><code class="name flex">
<span>def <span class="ident">omefolder_to_analysisfolder</span></span>(<span>input_folder: Union[str, pathlib.Path], output_folder: Union[str, pathlib.Path], panel_csv_file: Union[str, pathlib.Path], analysis_stacks: Sequence[Tuple[str, str, bool]], metalcolumn: str = 'Metal Tag', dtype=numpy.uint16)</span>
</code></dt>
<dd>
<div class="desc"><p>Convert OME tiffs to analysis tiffs that are more compatible with tools. A CSV with a boolean column can be used to select subsets of channels or metals from the stack. The channels of the tiff will have the same order as in the csv.'</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>input_folder</code></strong></dt>
<dd>Input folder</dd>
<dt><strong><code>output_folder</code></strong></dt>
<dd>Output folder</dd>
<dt><strong><code>panel_csv_file</code></strong></dt>
<dd>Name of the CSV file that contains the channels to be written out.</dd>
<dt><strong><code>analysis_stacks</code></strong></dt>
<dd>Array of analysis stack definitions in a tuple format (column, suffix, add_sum).</dd>
<dt><strong><code>metalcolumn</code></strong></dt>
<dd>Column name of the metal names.</dd>
<dt><strong><code>dtype</code></strong></dt>
<dd>Output numpy dtype</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def omefolder_to_analysisfolder(
    input_folder: Union[str, Path],
    output_folder: Union[str, Path],
    panel_csv_file: Union[str, Path],
    analysis_stacks: Sequence[Tuple[str, str, bool]],
    metalcolumn: str = &#34;Metal Tag&#34;,
    dtype=np.uint16,
):
    &#34;&#34;&#34;Convert OME tiffs to analysis tiffs that are more compatible with tools. A CSV with a boolean column can be used to select subsets of channels or metals from the stack. The channels of the tiff will have the same order as in the csv.&#39;

    Parameters
    ----------
    input_folder
        Input folder
    output_folder
        Output folder
    panel_csv_file
        Name of the CSV file that contains the channels to be written out.
    analysis_stacks
        Array of analysis stack definitions in a tuple format (column, suffix, add_sum).
    metalcolumn
        Column name of the metal names.
    dtype
        Output numpy dtype
    &#34;&#34;&#34;
    if isinstance(input_folder, str):
        input_folder = Path(input_folder)
    if isinstance(output_folder, str):
        output_folder = Path(output_folder)

    if not output_folder.exists():
        output_folder.mkdir(parents=True, exist_ok=True)

    for fol in os.listdir(input_folder):
        sub_fol = input_folder / fol
        for img in os.listdir(sub_fol):
            if not img.endswith(&#34;.ome.tiff&#34;):
                continue
            basename = img.rstrip(&#34;.ome.tiff&#34;)
            for (col, suffix, add_sum) in analysis_stacks:
                try:
                    omefile_2_analysisfolder(
                        sub_fol / img,
                        output_folder,
                        basename + suffix,
                        panel_csv_file=panel_csv_file,
                        metalcolumn=metalcolumn,
                        usedcolumn=col,
                        bigtiff=False,
                        dtype=dtype,
                    )
                except:
                    logger.exception(&#34;Error in {}&#34;.format(img))</code></pre>
</details>
</dd>
</dl>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="imctools.converters" href="index.html">imctools.converters</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="imctools.converters.ome2analysis.get_metals_from_panel" href="#imctools.converters.ome2analysis.get_metals_from_panel">get_metals_from_panel</a></code></li>
<li><code><a title="imctools.converters.ome2analysis.omefile_2_analysisfolder" href="#imctools.converters.ome2analysis.omefile_2_analysisfolder">omefile_2_analysisfolder</a></code></li>
<li><code><a title="imctools.converters.ome2analysis.omefolder_to_analysisfolder" href="#imctools.converters.ome2analysis.omefolder_to_analysisfolder">omefolder_to_analysisfolder</a></code></li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc"><cite>pdoc</cite> 0.8.5</a>.</p>
</footer>
</body>
</html>